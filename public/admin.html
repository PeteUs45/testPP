<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .login-box {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 400px;
    }
    .login-box h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #333;
    }
    .login-box input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e1e5ee;
      border-radius: 10px;
      font-size: 1rem;
      margin-bottom: 20px;
    }
    .login-box input:focus {
      outline: none;
      border-color: #667eea;
    }
    .login-box button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }
    .login-box button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(102,126,234,0.4);
    }
    .login-error {
      color: #dc2626;
      text-align: center;
      margin-bottom: 15px;
      display: none;
    }
    .navbar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px 30px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar h1 { font-size: 1.5rem; }
    .navbar-btns { display: flex; gap: 10px; }
    .navbar a, .navbar button {
      color: white;
      text-decoration: none;
      background: rgba(255,255,255,0.2);
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 1rem;
    }
    .navbar a:hover, .navbar button:hover {
      background: rgba(255,255,255,0.3);
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 30px; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    .stat-card h3 { color: #888; font-size: 0.85rem; text-transform: uppercase; margin-bottom: 10px; }
    .stat-card .value { font-size: 2.5rem; font-weight: 700; color: #333; }
    .stat-card.purple .value { color: #667eea; }
    .stat-card.green .value { color: #10b981; }
    .panel {
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    .panel-header {
      padding: 20px 25px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .panel-header h2 { color: #333; font-size: 1.2rem; }
    .refresh-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 16px 25px; text-align: left; }
    th { background: #f8f9fc; color: #666; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; }
    tr { border-bottom: 1px solid #f0f0f0; }
    tr:hover { background: #fafbff; }
    .user-id { color: #888; font-family: monospace; }
    .user-name { font-weight: 600; }
    .date { color: #888; font-size: 0.9rem; }
    .delete-btn {
      background: #fee2e2;
      color: #dc2626;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    .empty-state { text-align: center; padding: 60px 20px; color: #888; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-container">
    <div class="login-box">
      <h1>üîê Admin Login</h1>
      <p id="loginError" class="login-error">Mot de passe incorrect</p>
      <input type="password" id="passwordInput" placeholder="Mot de passe" onkeypress="if(event.key==='Enter')login()">
      <button onclick="login()">Se connecter</button>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden">
    <nav class="navbar">
      <h1>üõ°Ô∏è Admin Panel</h1>
      <div class="navbar-btns">
        <a href="/">‚Üê Formulaire</a>
        <button onclick="logout()">D√©connexion</button>
      </div>
    </nav>

    <div class="container">
      <div class="stats">
        <div class="stat-card purple">
          <h3>Total Utilisateurs</h3>
          <div class="value" id="totalUsers">-</div>
        </div>
        <div class="stat-card green">
          <h3>Inscrits Aujourd'hui</h3>
          <div class="value" id="todayUsers">-</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <h2>Liste des Utilisateurs</h2>
          <button class="refresh-btn" onclick="loadData()">üîÑ Rafra√Æchir</button>
        </div>
        <div id="tableContainer">
          <div class="empty-state">Chargement...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let authToken = localStorage.getItem('adminToken');

    // Check if already logged in
    if (authToken) {
      showAdmin();
    }

    async function login() {
      const password = document.getElementById('passwordInput').value;
      
      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        const data = await response.json();

        if (response.ok) {
          authToken = data.token;
          localStorage.setItem('adminToken', authToken);
          showAdmin();
        } else {
          document.getElementById('loginError').style.display = 'block';
        }
      } catch (error) {
        alert('Erreur de connexion');
      }
    }

    function logout() {
      localStorage.removeItem('adminToken');
      authToken = null;
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
    }

    function showAdmin() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('adminPanel').classList.remove('hidden');
      loadData();
    }

    async function loadData() {
      await Promise.all([loadStats(), loadUsers()]);
    }

    async function loadStats() {
      try {
        const response = await fetch('/api/stats', {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });
        if (response.status === 401) return logout();
        const stats = await response.json();
        document.getElementById('totalUsers').textContent = stats.total;
        document.getElementById('todayUsers').textContent = stats.today;
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function loadUsers() {
      const container = document.getElementById('tableContainer');
      
      try {
        const response = await fetch('/api/users', {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });
        if (response.status === 401) return logout();
        const users = await response.json();

        if (users.length === 0) {
          container.innerHTML = '<div class="empty-state">Aucun utilisateur inscrit</div>';
          return;
        }

        container.innerHTML = `
          <table>
            <thead><tr><th>ID</th><th>Pr√©nom</th><th>Nom</th><th>Date</th><th>Action</th></tr></thead>
            <tbody id="usersList"></tbody>
          </table>`;

        const tbody = document.getElementById('usersList');
        users.forEach(user => {
          const date = new Date(user.created_at).toLocaleString('fr-FR');
          tbody.innerHTML += `
            <tr>
              <td class="user-id">#${user.id}</td>
              <td class="user-name">${escapeHtml(user.prenom)}</td>
              <td>${escapeHtml(user.nom)}</td>
              <td class="date">${date}</td>
              <td><button class="delete-btn" onclick="deleteUser(${user.id})">Supprimer</button></td>
            </tr>`;
        });
      } catch (error) {
        container.innerHTML = '<div class="empty-state">Erreur de chargement</div>';
      }
    }

    async function deleteUser(id) {
      if (!confirm('Supprimer cet utilisateur ?')) return;
      
      try {
        await fetch(`/api/users/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + authToken }
        });
        loadData();
      } catch (error) {
        alert('Erreur');
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    setInterval(loadData, 30000);
  </script>
</body>
</html>
